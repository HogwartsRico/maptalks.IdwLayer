/*!
 * maptalks.IdwLayer v0.1.0
 * LICENSE : MIT
 * (c) 2016-2017 maptalks.org
 */
/*!
 * requires maptalks@>=0.31.0 
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("maptalks")):"function"==typeof define&&define.amd?define(["exports","maptalks"],e):e(t.maptalks=t.maptalks||{},t.maptalks)}(this,function(t,e){"use strict";function i(t,e){for(var i=Object.getOwnPropertyNames(e),n=0;n<i.length;n++){var r=i[n],o=Object.getOwnPropertyDescriptor(e,r);o&&o.configurable&&void 0===t[r]&&Object.defineProperty(t,r,o)}return t}function n(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function r(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function o(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):i(t,e))}function a(t){if(!(this instanceof a))return new a(t);this._canvas=t="string"==typeof t?document.getElementById(t):t,this._ctx=t.getContext("2d"),this._width=t.width,this._height=t.height,this._max=1,this._data=[]}a.prototype={defaultCellSize:25,defaultGradient:{0:"#000066",.1:"blue",.2:"cyan",.3:"lime",.4:"yellow",.5:"orange",.6:"red",.7:"Maroon",.8:"#660066",.9:"#990099",1:"#ff66ff"},data:function(t){return this._data=t,this},max:function(t){return this._max=t,this},add:function(t){return this._data.push(t),this},clear:function(){return this._data=[],this},cellSize:function(t){var e=this._cell=document.createElement("canvas"),i=e.getContext("2d");return this._r=t,e.width=e.height=t,i.beginPath(),i.rect(0,0,t,t),i.fill(),i.closePath(),this},resize:function(){this._width=this._canvas.width,this._height=this._canvas.height},gradient:function(t){var e=document.createElement("canvas"),i=e.getContext("2d"),n=i.createLinearGradient(0,0,0,256);e.width=1,e.height=256;for(var r in t)n.addColorStop(+r,t[r]);return i.fillStyle=n,i.fillRect(0,0,1,256),this._grad=i.getImageData(0,0,1,256).data,this},draw:function(t){this._cell||this.cellSize(this.defaultCellSize),this._grad||this.gradient(this.defaultGradient);var e=this._ctx;e.clearRect(0,0,this._width,this._height);for(var i,n=0,r=this._data.length;n<r;n++)i=this._data[n],e.globalAlpha=i[2]/this._max,e.drawImage(this._cell,i[0]-this._r,i[1]-this._r);var o=e.getImageData(0,0,this._width,this._height);return this._colorize(o.data,this._grad,5*t),e.putImageData(o,0,0),this},_colorize:function(t,e,i){for(var n,r=0,o=t.length;r<o;r+=4)n=4*t[r+3],t[r]=e[n],t[r+1]=e[n+1],t[r+2]=e[n+2],t[r+3]=256*i}};var s=function(t){function i(e,o,a){n(this,i),Array.isArray(o)||(a=o,o=null);var s=r(this,t.call(this,e,a));return s._idws=o||[],s}return o(i,t),i.prototype.getData=function(){return this._idws},i.prototype.setData=function(t){return this._idws=t||[],this.redraw()},i.prototype.addPoint=function(t){return t?(t[0]&&Array.isArray(t[0])?e.Util.pushIn(this._idws,t):this._idws.push(t),this.redraw()):this},i.prototype.onConfig=function(t){for(var e in t)if(options[e])return this.redraw();return this},i.prototype.redraw=function(){var t=this._getRenderer();return t&&(t.clearIdwCache(),t.setToRedraw()),this},i.prototype.isEmpty=function(){return!this._idws.length},i.prototype.clear=function(){return this._idws=[],this.redraw(),this.fire("clear"),this},i.prototype.toJSON=function(t){t||(t={});var i={type:this.getJSONType(),id:this.getId(),options:this.config()},n=this.getData();if(t.clipExtent){var r=new e.Extent(t.clipExtent),o=this._getIdwRadius();o&&(r=r._expand(o));for(var a=[],s=0,h=n.length;s<h;s++)r.contains(new e.Coordinate(n[s][0],n[s][1]))&&a.push(n[s]);i.data=a}else i.data=n;return i},i.fromJSON=function(t){return t&&"IdwLayer"===t.type?new i(t.id,t.data,t.options):null},i.prototype._getIdwRadius=function(){return this._getRenderer()?this._getRenderer()._idwRadius:null},i}(e.Layer);s.registerJSONType("IdwLayer"),s.registerRenderer("canvas",function(t){function i(){return n(this,i),r(this,t.apply(this,arguments))}return o(i,t),i.prototype.draw=function(){var t=this.getMap(),e=this.layer,i=t.getContainerExtent(),n=this.prepareCanvas(),r=i;if(n){if(!(n=n.convertTo(function(e){return t._pointToContainerPoint(e)})).intersects(i))return void this.completeRender();r=i.intersection(n)}this._idw||(this._idw=a(this.canvas)),this._updateOptions(),this._idwViews||(this._idwViews=[]);var o=e.getData();if(0!==o.length){var s=this._idwData(o,r);this._idw.data(s).draw(e.options.opacity),this.completeRender()}else this.completeRender()},i.prototype._updateOptions=function(){this._idw.cellSize(this.layer.options.cellSize||this._idw.defaultCellSize),this.layer.options.gradient&&this._idw.gradient(this.layer.options.gradient),this.layer.options.max&&this._idw.max(this.layer.options.max),this.layer.options.hasOwnProperty("opacity")||(this.layer.options.opacity=.3)},i.prototype.drawOnInteracting=function(){this.draw()},i.prototype._idwData=function(t){var i=this.getMap(),n=this.layer,r=[],o=this._idw._r,a=i.getSize(),s=new e.Extent(new e.Point([-o,-o]),new e.Point([a.width+o,a.height+o])),h=void 0===n.options.exp?1:n.options.exp,d=void 0===n.options.max?1:n.options.max,p=o/2,c=Math.ceil((s.xmax-s.xmin)/o)+1,l=void 0,u=void 0,f=void 0,w=void 0,y=void 0,_=void 0,g=void 0;for(l=0,u=Math.ceil((s.ymax-s.ymin)/o)+1;l<u;l++)for(w=0,y=c;w<y;w++){var v=l*o,m=w*o,x=0,b=0;for(g=0,_=t.length;g<_;g++){var C=i.coordinateToContainerPoint(new e.Coordinate([t[g][0],t[g][1]])),O=new e.Point(m-p,v-p).distanceTo(C),R=void 0!==t[g].alt?t[g].alt:void 0!==t[g][2]?+t[g][2]:1;if(0===O){x=R,b=1;break}var I=Math.pow(O,h);x+=R/I,b+=1/I}(f=[w*o,l*o,x/b])&&r.push([Math.round(f[0]),Math.round(f[1]),Math.min(f[2],d)])}return r},i.prototype.onZoomEnd=function(){delete this._idwViews,t.prototype.onZoomEnd.apply(this,arguments)},i.prototype.onResize=function(){this.canvas&&(this._idw._width=this.canvas.width,this._idw._height=this.canvas.height),t.prototype.onResize.apply(this,arguments)},i.prototype.onRemove=function(){this.clearHeatCache(),delete this._idw},i.prototype.clearHeatCache=function(){delete this._idwViews},i}(e.renderer.CanvasRenderer)),t.IdwLayer=s,Object.defineProperty(t,"__esModule",{value:!0}),"undefined"!=typeof console&&console.log("maptalks.IdwLayer v0.1.0, requires maptalks@>=0.31.0.")});